---
title: Brief Workflow of Subtomogram Averaging using EMAN2
seo_title: Brief Workflow of Subtomogram Averaging using EMAN2
summary: A brief introduction about workflow of SubTomogram Average using EMAN2.99.
description: 
slug: eman2-sta-averaging-tutorial
author: Zhen Huang

draft: false
date: 2022-09-01T17:07:01+08:00
lastmod: 
expiryDate: 
publishDate: 

feature_image: 
feature_image_alt: 

categories:
    - Research Study
tags:
    - cryo-ET
series:
   - EMAN2

toc: true
related: true
social_share: true
newsletter: true
disable_comments: false
math: true
---

## Generate Initial Model

When employing **Reference-based boxing** to identify the particles of interest, it's essential to manually generate an initial model. Based on this initial model, similar particles in the tomogram are automatically searched, i.e., via template matching. To construct this initial model, it typically requires the manual selection of 30-50 reference particles.

### Manual Boxing

Within the GUI, select the tomogram that needs particle picking. Generally, if it's a tomogram produced by the prior EMAN2 3D Reconstruction, after clicking "Browse," it should directly navigate to the `tomograms/` directory, where you can select the respective tomogram.

Upon entering manual selection after 3D reconstruction, you'll find that the tomogram generated by EMAN2 comes with bin4 (related to the 'outsize' set during 3D reconstruction). This assists your manual selection as, under bin4, the image contrast is significantly improved, allowing for a quicker visual identification of the particles of interest. However, this doesn't impact your initial model's binning: EMAN2, in this stage, only logs the 3D coordinates of the particle. When extracting the particle, it reverts back to the tilt series, instead of directly separating from this bin4 tomogram.

To run this script, you can either:

- Use the GUI directly: ![manual-boxing-2024-04-16-11-02-12](https://lfs.zhenhuang.top/images/manual-boxing-2024-04-16-11-02-12.png#small)
- Or execute the command:

```bash
e2spt_boxer.py tomograms/xxx.hdf
```

Upon launching, three windows pop up:

![Main-window-Manual-boxing-2024-04-16-11-03-04](https://lfs.zhenhuang.top/images/Main-window-Manual-boxing-2024-04-16-11-03-04.jpg#small)

1. **Main Window**: Displays the tomogram. Use `~` and `1`, or the right-hand slider to adjust the Z-axis. Particles selected with the left mouse button will appear in the Particle List window. Two parameters to pay attention to are Box size and Filt.
   
   (a) Box size: This setting defines the size of the particle box. Estimate the particle size and select a Box size about twice that. For the example data used in the EMAN2 tutorial:

   $Data resolution = 2.62 Å/pixel$

   $Known ribosome size \approx 25nm = 250 Å$

   $Ribosome size (on the sensor) = \frac{Known-ribosome-size}{Data-resolution} \approx 95pixel $

   Doubling the ribosome size gives approximately 191 pixels, hence the tutorial chooses an unbinned box size of 192. For this tomogram, due to binning=4, a box size of 48 is appropriate. 

   (b) Filt: Adjusting this parameter can enhance the image contrast, making the particles more pronounced and aiding manual selection. For this tutorial data, a setting of around 70 is recommended.
   
2. **Options Window**: Used mainly for setting particle tags, facilitating classification and subsequent data processing. Typically, during the initial model construction, it's set as `initribo`. New tags can be created, and renaming is also possible. Proper tag naming significantly assists subsequent processing.

3. **Particle List Window**: Displays selected particles. To remove any unwanted ones, hold the `Shift` key and click.

Upon completion of particle picking, simply close the windows. The results are stored as a list in `info/xxx_info.json`.

### Particle Extraction

From the particle positions obtained in the previous step, EMAN2 goes back to the tilt series to extract the tilt series for each particle, followed by 3D reconstruction for each individual particle. Therefore, the bin2/bin4 tomograms used in the prior step only served as references for identifying and selecting each particle.

To employ this method, select "Extract particles". In the GUI, choose the tomogram and the tags of the particles picked manually from the previous step. For the sample data, set boxsize_unbin=192. Depending on your computer/server, select an appropriate number of threads (default is 12). The "shrink" is equivalent to binning or pixel merging. As the initial model in bin4 can search for particles more efficiently than that in bin1, the resultant initial model is in bin4. The recommended approach is to not set "shrink" during particle extraction, and set shrink=4 when generating the initial model.

![particle-extraction-2024-04-16-11-07-14](https://lfs.zhenhuang.top/images/particle-extraction-2024-04-16-11-07-14.jpg#small)

The outcome of this step is the generation of a 3D reconstruction hdf file for each particle. The next step is to produce a particle set, which will be used to generate the corresponding model.

"Build sets" is the method to produce particle sets and is the final step of particle extraction. Select the stack files generated by the 3D reconstruction of each particle from the previous step, usually stored in the `particles3d/` directory, and then input the tags of the initial model particles.

![build-set-2024-04-16-11-07-31](https://lfs.zhenhuang.top/images/build-set-2024-04-16-11-07-31.jpg#small)

Once run, you can move on to the next step: generating the initial model.

### Initial Model Generation

#### EMAN2.91 Generate initial model

Generating the initial model is straightforward. Choose the particle set produced in the previous step, set the iteration count to around 5, and the shrink value to 4. If shrink is set to 1 or 2 (and was also set to 1 earlier), the generation process becomes very slow, making subsequent template matching equally sluggish and inefficient. Hence, creating an initial model in bin4 first is logical.

![generate-initial-model-2024-04-16-11-07-54](https://lfs.zhenhuang.top/images/generate-initial-model-2024-04-16-11-07-54.jpg#small)

The final result is:

![the-initial-model-2024-04-16-11-08-17](https://lfs.zhenhuang.top/images/the-initial-model-2024-04-16-11-08-17.png#small)

As you can see, the initial model structure is very rough, with a resolution of about 38 Ångström. However, for the subsequent particle template search, this is sufficient.

Using a more refined high-resolution structure as the initial model for particle search won't yield better results, because the noise level and other characteristics of this initial model do not match the target tomogram.

#### New initial model generator in versions after EMAN2.99

New features in the recent version of the initial model generator include defining target resolution and the ability to classify particles and generate multiple initial models.

![new-initial-model-generator-2024-04-16-11-08-34](https://lfs.zhenhuang.top/images/new-initial-model-generator-2024-04-16-11-08-34.jpg#small)

## Template Matching

To achieve a higher resolution, the final structure must have a high Signal-to-Noise Ratio (SNR). An essential foundation for improving the SNR is to overlay and average a large number of subtomograms, as this can significantly reduce shot noise. Therefore, the 30-50 particles used for the initial model generation are far from enough. In practice, 1000-3000 particles are typically selected.

Having obtained the initial model in the previous step, you will use this model as a template to find several thousand more particles, a process known as **Template Matching**. Of course, if you've already obtained thousands of particles using the Convnet based auto-boxing method, there's no need for template matching, and you can proceed directly to the 3D Refinement phase.

### Reference-based Boxing

To run this script, click on "Reference-based boxing" directly in the GUI:

![reference-based-boxing-2024-04-16-11-09-00](https://lfs.zhenhuang.top/images/reference-based-boxing-2024-04-16-11-09-00.jpg#small)

Because biases may occur during the search, further screening is necessary.

Open "Manual boxing", and you will see several more particles in the "Stored Boxes" column (not 1000 in the illustration because of filtering), indicating successful search.

![manual-boxing-2024-04-16-11-09-19](https://lfs.zhenhuang.top/images/manual-boxing-2024-04-16-11-09-19.jpg#small)

Continue using the manual selection method for filtering. This step is crucial. If many irrelevant particles or features (like cell membranes, ice particles, background noise) are mixed in as target particles, "false details" may appear after overlaying. Close the window after filtering; the results will also be recorded in `info/xxx_info.json`.

![main-window-manual-boxing-2024-04-16-11-09-41](https://lfs.zhenhuang.top/images/main-window-manual-boxing-2024-04-16-11-09-41.jpg#small)

### Particle Extraction

Since this extraction involves thousands of particles, the operation time will be much longer.

EMAN2.99 has integrated Subtomogram Refinement and Subtilt Refinement, so there's no need to refine step by step as in older versions, just extract the bin1 particles.

![particle-extraction-2-2024-04-16-11-10-02](https://lfs.zhenhuang.top/images/particle-extraction-2-2024-04-16-11-10-02.jpg#small)

Then use "Build Sets" to construct the particle set.

![build-set-2-2024-04-16-11-10-38](https://lfs.zhenhuang.top/images/build-set-2-2024-04-16-11-10-38.jpg#small)

## 3D Refinement

In versions after EMAN2.99, Subtomogram Refinement and Subtilt Refinement have been integrated into one script. Just run `e2spt_refine_new.py` to complete both processes, which also addresses some issues that arose in EMAN2.91 during Subtilt Refinement.

To run the script, execute:

```bash
e2spt_refine_new.py --ptcls=sets/ribo_bin1.lst --ref=sptsgd_00/output_cls0.hdf --startres=50.0 --goldstandard --sym=c1 --iters=p3,t2,p,t,r,d --keep=0.90 --parallel=thread:20 --threads=20
```

Or select from the GUI:

![refinement-3d-2024-04-16-11-11-02](https://lfs.zhenhuang.top/images/refinement-3d-2024-04-16-11-11-02.jpg#small)

The result after running:

![refinement-3d-result-2024-04-16-11-11-19](https://lfs.zhenhuang.top/images/refinement-3d-result-2024-04-16-11-11-19.png#small)

## References

EMAN2 Introductory Tutorials: https://blake.bcm.edu/emanwiki/EMAN2/Tutorials

EMAN2 Tomography and Subtomogram/Subtilt Averaging Workflow Tutorial: https://blake.bcm.edu/emanwiki/EMAN2/e2TomoSmall

New Subtomogram-subtilt Refinement: https://blake.bcm.edu/emanwiki/EMAN2/e2tomo_new
